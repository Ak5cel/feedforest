{% extends "base.html" %}

{% block content %}
<div class="container padding-bottom">
  <div class="row">
    <div class="col-md-12">
      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show">
              {{ message }}
              <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
    </div>
    <div class="col">
      <h3 class="mt-4 mt-md-5 mb-4">My Articles</h3>
      <div class="pt-1">
        <ul class="list-group list-group-flush" id="loader">
          <template id="article_template">
            <li class="article toggle-display list-group-item px-3 d-flex justify-content-between"
                data-status="bookmarked"
                data-article-id=""
                id="articleItem">
              <div class="d-flex flex-column justify-content-end">
                <small>
                  <a id="feedLink" href="" class="text-muted"></a>
                </small>
                <h6 class="pr-3">
                  <a id="articleLink" class="text-dark" href=""></a>
                </h6> 
                
                <p id="publishedOn" class="small text-muted">
                  
                </p>
                
              </div>
            </li>
          </template>
        </ul>
        <a href="#" class="btn btn-primary" id="loadBtn" data-feed-id="1" data-page="0">Load more</a>
      </div>
    </div>
  </div>
</div>

  
{% endblock content %}

{% block scripts %}
  <script>
    $(document).ready(function() {

      function loadArticles(page, feed_id, loader) {
        // var loader = document.querySelector('#loader');
        var template = document.querySelector('#article_template');
        var loadBtn = $(loader).siblings('#loadBtn')[0];

        url = `/load?feed_id=${feed_id}&page=${page}`;

        $.ajax({
          type: 'POST',
          url: url,
          success: function(res) {
            var articles = res["articles"];

            for (var i = 0; i < articles.length; i++) {
              let template_clone = template.content.cloneNode(true);
              let articleItem = template_clone.querySelector('#articleItem');
              
              // Query and update the template content
              articleItem.setAttribute("data-article-id", articles[i].id);
              template_clone.querySelector('#feedLink').setAttribute("href", res["site_url"]);
              template_clone.querySelector('#feedLink').innerHTML = res["feed_name"].toUpperCase();
              template_clone.querySelector('#articleLink').setAttribute("href", articles[i].link);
              template_clone.querySelector('#articleLink').innerHTML = articles[i].title;
              template_clone.querySelector('#publishedOn').innerHTML = articles[i].published_on + ' UTC';

              // Append template to DOM
              loader.appendChild(template_clone);

              
              if (res["has_next"]) {
                // Increase page count
                loadBtn.setAttribute("data-page", page);
              } else {
                // If there are no more articles, remove the Load More button
                $(loadBtn).remove();
              }

              
            }
          },
          error: function(err) {
            console.log(err);
          }
        })
      }

      

      $('#loadBtn').on('click', (e) => {
        e.preventDefault();

        var loader = $(e.target).siblings('#loader')[0];
        let page = parseInt(e.target.getAttribute("data-page"));
        let feedId = parseInt(e.target.getAttribute("data-feed-id"));

        loadArticles(page + 1, feedId, loader);
      })

    })
  </script>
{% endblock scripts %}